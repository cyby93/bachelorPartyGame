<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAID NIGHT - Host</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div id="host-container">
    <!-- Lobby Sidebar (hidden by default) -->
    <div id="lobby-sidebar" style="display: none;">
      <div class="sidebar-content">
        <h1 class="game-title">RAID NIGHT</h1>
        <div class="server-info">
          <h3>Server IP</h3>
          <p id="server-ip">Loading...</p>
        </div>
        <div class="qr-code-container">
          <div id="qr-code"></div>
          <p class="qr-hint">Scan to join!</p>
        </div>
        <div class="player-list">
          <h3>Players Connected</h3>
          <div id="player-list-items">
            <p class="waiting-text">Waiting for players...</p>
          </div>
        </div>
        <button id="start-game-btn" class="start-button" disabled>
          START GAME
        </button>
      </div>
    </div>
    
    <canvas id="game-canvas"></canvas>
    
    <!-- Restart button (hidden by default) -->
    <button id="restart-game-btn" class="restart-button" style="display: none;">
      RESTART GAME
    </button>
    
    <div id="ui-overlay">
      <!-- <div class="boss-health-bar">
        <div class="boss-name">Illidan Stormrage</div>
        <div class="health-bar-container">
          <div class="health-bar-fill" id="boss-hp-bar" style="width: 100%;"></div>
        </div>
      </div> -->
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script type="module" src="/js/config/SkillDatabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script type="module">
    import Game from './js/Game.js';
    const socket = io();
    const canvas = document.getElementById('game-canvas');
    const game = new Game(canvas, socket);
    let currentPlayers = [];


    socket.on('connect', () => {
      console.log('Connected as HOST');
      socket.emit('join_game', {
        name: 'Host Display',
        className: 'Warrior',
        isHost: true
      });
      game.scenes.lobby.setHost(true);
      
      // Get server IP and generate QR code
      const serverIP = window.location.hostname + ':' + window.location.port;
      document.getElementById('server-ip').textContent = serverIP;
      
      // Generate QR code
      const qrContainer = document.getElementById('qr-code');
      qrContainer.innerHTML = ''; // Clear any existing QR code
      new QRCode(qrContainer, {
        text: window.location.origin + '/controller.html',
        width: 150,
        height: 150,
        colorDark: '#000000',
        colorLight: '#ffffff'
      });
    });
    
    socket.on('game_state', (state) => {
      if (state.boss) {
        const hpBar = document.getElementById('boss-hp-bar');
        if(!hpBar) return;
        const hpPercent = (state.boss.hp / state.boss.maxHp) * 100;
        hpBar.style.width = hpPercent + '%';
      }
    });
    
    // Start button functionality
    const startButton = document.getElementById('start-game-btn');
    startButton.addEventListener('click', () => {
      socket.emit('start_game');
    });
    
    socket.on('game_started', () => {
      startButton.style.display = 'none';
    });
    
    // Restart button functionality
    const restartButton = document.getElementById('restart-game-btn');
    restartButton.addEventListener('click', () => {
      socket.emit('restart_game');
      restartButton.style.display = 'none';
    });
    
    // Show restart button when in result scene
    setInterval(() => {
      if (game.currentScene && game.currentScene.constructor.name === 'ResultScene') {
        restartButton.style.display = 'block';
      } else {
        restartButton.style.display = 'none';
      }
    }, 100);
    
    // Update player list
    socket.on('init_state', (state) => {
      updatePlayerList(Object.values(state.players));
    });
    
    socket.on('player_joined', (player) => {
      updatePlayerList([...currentPlayers, player]);
    });

    socket.on('player_left', (player) => {
      updatePlayerList(currentPlayers.filter(p => player.id !== p.id));
    });

    
    function updatePlayerList(players) {
      currentPlayers = players;
      const listContainer = document.getElementById('player-list-items');
      const playerArray = Object.values(players).filter(p => !p.isHost);
      
      if (playerArray.length === 0) {
        listContainer.innerHTML = '<p class="waiting-text">Waiting for players...</p>';
        startButton.disabled = true;
      } else {
        listContainer.innerHTML = playerArray.map(p => 
          `<div class="player-item" style="border-left-color:${p.classData.color}">
            <span class="player-name">${p.name}</span>
            <span class="player-class" style="color:${p.classData.color}">${p.className}</span>
          </div>`
        ).join('');
        startButton.disabled = false;
      }
    }
    
    game.start();
  </script>
</body>
</html>
